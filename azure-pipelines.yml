# azure-pipelines.yml

trigger:
  branches:
    include:
      - main   # Adjust the branch as needed

pool:
  vmImage: 'ubuntu-latest'

variables:
  TF_VAR_client_id: $(ARM_CLIENT_ID)
  TF_VAR_client_secret: $(ARM_CLIENT_SECRET)
  TF_VAR_subscription_id: $(ARM_SUBSCRIPTION_ID)
  TF_VAR_tenant_id: $(ARM_TENANT_ID)

steps:
  # Use the AzureCLI task to authenticate with the Azure service connection
  - task: AzureCLI@2
    inputs:
      azureSubscription: 'TF-deployment'   # Your Azure service connection name
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Logged in to Azure"
        az account show

  # Install Terraform
  - script: |
      echo "##[section]Install Terraform"
      sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
      curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
      sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
      sudo apt-get update && sudo apt-get install terraform
    displayName: 'Install Terraform'

  # Checkout the repository containing the Terraform scripts
  - checkout: self
    clean: true

  # Initialize Terraform
  - script: |
      terraform init
    displayName: 'Terraform Init'

  # Plan Terraform changes
  - script: |
      terraform plan -out=tfplan
    displayName: 'Terraform Plan'

  # Apply Terraform changes
  - script: |
      terraform apply -auto-approve tfplan
    displayName: 'Terraform Apply'

